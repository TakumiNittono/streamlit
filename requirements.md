# RAG Demo with File Manager & Reference Chat（Phase1+）

## 📊 プロジェクト進捗状況

### 全体進捗

- **現在のフェーズ**: Phase 1
- **全体進捗**: 83% (5/6 タスク完了)
- **最終更新日**: 2024-12-19

**進捗バー**: ✅✅✅✅✅⬜ (5/6)

### Phase 1: 基本機能実装

| # | タスク | ステータス | 担当 | 備考 |
|---|--------|-----------|------|------|
| 1.1 | プロジェクトセットアップ（ディレクトリ構成、requirements.txt） | ✅ 完了 | - | - |
| 1.2 | `rag.py` の実装（RAG検索・LLM回答生成） | ✅ 完了 | - | - |
| 1.3 | `ingest.py` の実装（ファイルインデックス処理） | ✅ 完了 | - | - |
| 1.4 | `app.py` の実装（ファイル管理UI） | ✅ 完了 | - | - |
| 1.5 | `app.py` の実装（チャットUI） | ✅ 完了 | - | - |
| 1.6 | 動作確認・テスト | 🟡 進行中 | - | - |

**凡例**: ✅ 完了 | 🟡 進行中 | ⬜ 未着手 | ❌ ブロック

---

## 1. 目的（WHY）

本プロジェクトの目的は、RAGアプリに「ファイル管理」と「根拠参照付きチャット」を統合し、以下を実現することである。

- 外部ユーザーが触って理解できる PoC
- 「AIが何を根拠に答えているか」が明確なUI
- 将来の業務システム（判断エンジン / BPO / 社内AI）への布石

## 2. スコープ定義

### ✅ In Scope（今回やること）

- ドキュメントのアップロード / 削除
- アップロードしたファイルの一覧表示
- ファイル削除時の Chroma再構築
- チャットUI（RAG）
- チャット回答に参照ドキュメント・ページ番号を明示
- OpenAI LLM による回答生成（検索はローカル）

### ❌ Out of Scope（今回はやらない）

- ユーザー認証（Auth）
- ロール管理
- 同時編集・履歴管理
- 本番SLA / 監視 / バックアップ

## 3. 技術スタック（固定）

| 役割 | 技術 |
|------|------|
| UI | Streamlit |
| RAG制御 | LangChain |
| Vector DB | Chroma（Persistent / ローカル） |
| Embedding | sentence-transformers（all-MiniLM-L6-v2） |
| LLM | OpenAI API（gpt-4o-mini） |
| ファイル保存 | ローカルファイルシステム |

## 4. ディレクトリ構成（必須）

```
rag-streamlit/
├ app.py                 # Streamlit UI（チャット＋管理）
├ ingest.py              # 再インデックス処理
├ rag.py                 # 検索・生成ロジック
├ requirements.txt
├ docs/                  # アップロードされたファイル
├ chroma_db/             # Chroma 永続DB
└ tmp/                   # アップロード一時保存（任意）
```

## 5. 機能要件（WHAT）

### 5.1 ファイル管理画面（左サイドバー） ✅

**進捗**: ✅ 完了

#### 機能

- PDF / txt / md ファイルのアップロード
- docs/ 配下に保存
- 既存ファイルの一覧表示
- ファイル削除（1件ずつ）

#### UI要件

- Streamlit Sidebar に配置
- 削除時は確認表示（Are you sure?）
- 操作後はステータスメッセージを表示

#### 振る舞い

- ファイル追加 or 削除時：
  - Chroma DB を再構築
  - ingest 処理を再実行

### 5.2 Ingest（自動再インデックス） ✅

**進捗**: ✅ 完了

#### 条件

以下のタイミングで実行：

- ファイルアップロード後
- ファイル削除後
- Chroma DB が存在しない場合

#### 処理内容

- docs/ 内の全ファイルを再読込
- chunk_size = 800
- chunk_overlap = 120
- 既存 Chroma DB は削除して再生成

### 5.3 チャット機能（メイン画面） ✅

**進捗**: ✅ 完了

#### UI構成

- チャット入力欄
- ユーザー発言表示
- AI回答表示
- 参照情報表示（折りたたみ）

### 5.4 RAG検索仕様 ✅

**進捗**: ✅ 完了

- 検索対象：Chroma DB
- 検索数：k = 4
- 検索結果は以下情報を含むこと：
  - ファイル名（source）
  - ページ番号（page）
  - 該当テキスト（chunk）

### 5.5 回答生成（LLM） ✅

**進捗**: ✅ 完了

#### 使用モデル

- OpenAI API
- gpt-4o-mini

#### 生成ルール（必須）

以下のプロンプト制約を必ず使用：

```
あなたは業務アシスタントです。
以下の「参照情報」に基づいてのみ回答してください。
参照情報に書かれていない内容は「分かりません」と答えてください。

【参照情報】
{context}

【質問】
{question}
```

#### フォールバック

- APIキー未設定時：
  - LLMを使わず、検索結果の抽出表示に切り替える

### 5.6 チャット参照表示（超重要） ✅

**進捗**: ✅ 完了

#### 表示仕様

- 回答の下に「参照元」セクションを表示
- 各参照に以下を含める：
  - `[1] sample.pdf (page 3)`
  - クリック or expander で該当チャンク全文を表示
- 👉 「なぜこの答えなのか」が一目で分かるUI

## 6. 非機能要件（QUALITY）

### 安定性

- ファイルが0件でもアプリは起動する
- DB不在時は自動再生成

### セキュリティ

- APIキーは環境変数管理
- ファイルアップロードは管理者利用前提
- 外部公開時はデモ用途を想定

### パフォーマンス

- 小〜中規模ファイル（数十PDF）を想定
- 同時アクセスは考慮しない

## 7. 将来拡張（設計だけ意識）

### Phase 2: 機能拡張（予定）

| # | 機能 | 優先度 | ステータス |
|---|------|--------|-----------|
| 2.1 | チャットログ保存 | 中 | ⬜ 未着手 |
| 2.2 | ファイルごとのメタ情報管理 | 中 | ⬜ 未着手 |
| 2.3 | 検索結果の並び替え・フィルタリング | 低 | ⬜ 未着手 |

### Phase 3: インフラ移行（予定）

| # | 機能 | 優先度 | ステータス |
|---|------|--------|-----------|
| 3.1 | Supabase Storage への切替 | 低 | ⬜ 未着手 |
| 3.2 | Azure OpenAI 移行 | 低 | ⬜ 未着手 |
| 3.3 | Azure PostgreSQL 移行 | 低 | ⬜ 未着手 |

### Phase 4: セキュリティ・運用（予定）

| # | 機能 | 優先度 | ステータス |
|---|------|--------|-----------|
| 4.1 | ユーザー認証（Auth） | 高 | ⬜ 未着手 |
| 4.2 | ロール管理 | 中 | ⬜ 未着手 |
| 4.3 | 同時編集・履歴管理 | 低 | ⬜ 未着手 |
| 4.4 | 本番SLA / 監視 / バックアップ | 高 | ⬜ 未着手 |

## 8. 進捗更新ガイドライン

### ステータスの更新方法

タスクが完了したら、以下のようにステータスを更新してください：

1. **全体進捗テーブル**の該当タスクのステータスを更新
   - ⬜ 未着手 → 🟡 進行中 → ✅ 完了
2. **機能要件セクション**の該当機能の進捗を更新
   - 例: `**進捗**: ⬜ 未着手` → `**進捗**: ✅ 完了`
3. **全体進捗率**を更新
   - 例: `**全体進捗**: 0% (0/6 タスク完了)` → `**全体進捗**: 16% (1/6 タスク完了)`
4. **進捗バー**を更新
   - 例: `⬜⬜⬜⬜⬜⬜ (0/6)` → `✅⬜⬜⬜⬜⬜ (1/6)`
   - 完了したタスクは ✅、未完了は ⬜ で表示
5. **最終更新日**を更新
   - 例: `**最終更新日**: 2024-01-15`

### ステータス記号の意味

- ✅ **完了**: 実装・テスト完了
- 🟡 **進行中**: 現在作業中
- ⬜ **未着手**: まだ開始していない
- ❌ **ブロック**: 問題が発生し、一時停止中

### 進捗更新のタイミング

- タスク開始時: ⬜ → 🟡
- タスク完了時: 🟡 → ✅
- 問題発生時: 🟡 → ❌（必要に応じて備考欄に記載）

## 9. 実装指示（Cursor用）

以下の指示をそのままCursorに貼り付けて使用してください：

```
あなたはシニアPythonエンジニアです。
上記要件定義に従って、以下を実装してください。

1. Streamlit サイドバーにファイル管理UIを追加
2. ファイルアップロード / 削除時に Chroma DB を再構築
3. チャットUIで RAG 検索＋ OpenAI LLM による回答生成
4. 回答には必ず参照ファイル名とページ番号を表示
5. Embedding は sentence-transformers を使用し、OpenAI は回答生成のみに使用してください
6. APIキーは環境変数から取得してください

実装完了後、要件定義書の進捗状況を更新してください。
```

